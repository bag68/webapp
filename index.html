<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- ... (остальная часть head без изменений) ... -->
    <style>
        /* Добавим стиль для кнопки повтора */
        .retry-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            margin-top: 15px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- ... (остальная часть body без изменений) ... -->

    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        tg.setHeaderColor('#6a11cb');
        tg.setBackgroundColor('#1a1a2e');
        
        // Конфигурация API - ДОБАВИМ ПРОВЕРКУ НА ДОСТУПНОСТЬ
        const API_BASE_URL = 'https://marketplace.pigfarm.ltd/api';
        const ACCESS_TOKEN = 'T4hhhTxmRs_B8jjwKgw0FIjQGN0QtS4YigTHKyCrkzk';
        
        // Элементы интерфейса
        // ... (без изменений) ...
        
        // Состояние приложения - ДОБАВИМ ФЛАГ ДЛЯ ДЕМО-РЕЖИМА
        let productsLoaded = false;
        let balanceLoaded = false;
        let ordersLoaded = false;
        let useDemoData = false;
        
        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', () => {
            // ... (без изменений) ...
            
            // Загружаем данные с проверкой доступности API
            checkApiAvailability().then(available => {
                if (available) {
                    loadProducts();
                } else {
                    showNotification('API недоступно. Используются демо-данные');
                    loadMockData();
                    useDemoData = true;
                }
            });
        });
        
        // Функция проверки доступности API
        async function checkApiAvailability() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'HEAD',
                    timeout: 3000
                });
                return response.ok;
            } catch (error) {
                console.error('API недоступно:', error);
                return false;
            }
        }

        // Функция загрузки товаров - ДОБАВИМ ОБРАБОТКУ ОШИБОК
        async function loadProducts() {
            try {
                productsContainer.innerHTML = '<div class="loader"><div class="loader-spinner"></div><p>Загрузка товаров...</p></div>';
                
                const response = await fetch(`${API_BASE_URL}/client/catalog`, {
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Ошибка ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data?.items?.length > 0) {
                    renderProducts(data.items);
                    productsLoaded = true;
                } else {
                    throw new Error('Товары не найдены');
                }
            } catch (error) {
                console.error('Ошибка при загрузке товаров:', error);
                
                // Добавим кнопку повтора и сообщение
                productsContainer.innerHTML = `
                    <div class="error-message">
                        Ошибка загрузки: ${error.message}
                        <button class="retry-btn" id="retry-products">
                            <i class="fas fa-sync-alt"></i> Повторить
                        </button>
                    </div>
                `;
                
                document.getElementById('retry-products').addEventListener('click', loadProducts);
                
                // Если API недоступно, используем демо-данные
                if (!useDemoData) {
                    setTimeout(() => {
                        if (!productsLoaded) {
                            loadMockData();
                            useDemoData = true;
                        }
                    }, 2000);
                }
            }
        }
        
        // Функция загрузки баланса - ДОБАВИМ ОБРАБОТКУ ОШИБОК
        async function loadBalance() {
            try {
                balanceAmount.innerHTML = '<div class="loader-spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>';
                
                const response = await fetch(`${API_BASE_URL}/client/balance`, {
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Ошибка ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                balanceAmount.innerHTML = `${data.balance.toLocaleString()}<span class="balance-currency">₽</span>`;
                balanceLoaded = true;
            } catch (error) {
                console.error('Ошибка при загрузке баланса:', error);
                
                // Установим демо-баланс
                balanceAmount.innerHTML = `12 560<span class="balance-currency">₽</span>`;
                balanceLoaded = true;
                
                showNotification(`Ошибка загрузки баланса: ${error.message}`);
            }
        }
        
        // Функция загрузки заказов - ДОБАВИМ ОБРАБОТКУ ОШИБОК
        async function loadOrders() {
            try {
                ordersContainer.innerHTML = '<div class="loader"><div class="loader-spinner"></div><p>Загрузка заказов...</p></div>';
                
                const response = await fetch(`${API_BASE_URL}/client/orders`, {
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Ошибка ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data?.orders?.length > 0) {
                    renderOrders(data.orders);
                    ordersLoaded = true;
                } else {
                    throw new Error('Заказов нет');
                }
            } catch (error) {
                console.error('Ошибка при загрузке заказов:', error);
                
                // Добавим кнопку повтора и сообщение
                ordersContainer.innerHTML = `
                    <div class="error-message">
                        Ошибка загрузки: ${error.message}
                        <button class="retry-btn" id="retry-orders">
                            <i class="fas fa-sync-alt"></i> Повторить
                        </button>
                    </div>
                `;
                
                document.getElementById('retry-orders').addEventListener('click', loadOrders);
                
                // Если API недоступно, используем демо-данные
                if (!useDemoData) {
                    setTimeout(() => {
                        if (!ordersLoaded) {
                            loadMockData();
                            useDemoData = true;
                        }
                    }, 2000);
                }
            }
        }
        
        // Функция отображения товаров - УПРОЩИМ ДЕМО-ДАННЫЕ
        function renderProducts(products) {
            productsContainer.innerHTML = '';
            
            products.forEach(product => {
                // ... (без изменений) ...
            });
        }
        
        // Имитация данных для демонстрации - ОБНОВИМ ДАННЫЕ
        function loadMockData() {
            console.warn('Используются демонстрационные данные');
            useDemoData = true;
            
            // Демо-товары
            const mockProducts = [
                { 
                    id: 1, 
                    name: "Кроссовки Nike Air Force", 
                    price: 8900, 
                    image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80", 
                    rating: 4.8, 
                    reviews: 124, 
                    stock: 15,
                    description: "Классические кроссовки Nike Air Force с современным дизайном и улучшенным комфортом."
                },
                { 
                    id: 2, 
                    name: "Футболка Oversize", 
                    price: 2490, 
                    image: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80", 
                    rating: 4.5, 
                    reviews: 87, 
                    stock: 42,
                    description: "Стильная оверсайз футболка из хлопка премиум качества."
                },
                { 
                    id: 3, 
                    name: "Джинсы Slim Fit", 
                    price: 4500, 
                    image: "https://images.unsplash.com/photo-1542272604-787c3835535d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80", 
                    rating: 4.7, 
                    reviews: 210, 
                    stock: 8,
                    description: "Ультрамодные джинсы slim fit с эластичным материалом."
                },
                { 
                    id: 4, 
                    name: "Куртка Windbreaker", 
                    price: 7800, 
                    image: "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80", 
                    rating: 4.9, 
                    reviews: 156, 
                    stock: 5,
                    description: "Легкая ветровка с водоотталкивающей пропиткой."
                }
            ];
            
            renderProducts(mockProducts);
            productsLoaded = true;
            
            // Демо-баланс
            balanceAmount.innerHTML = `12 560<span class="balance-currency">₽</span>`;
            balanceLoaded = true;
            
            // Демо-заказы
            const mockOrders = [
                { 
                    id: "#PF-4826", 
                    date: "2023-06-15", 
                    amount: 8900, 
                    status: "completed", 
                    items: 1,
                    title: "Кроссовки Nike Air Force"
                },
                { 
                    id: "#PF-5129", 
                    date: "2023-06-10", 
                    amount: 12990, 
                    status: "completed", 
                    items: 3,
                    title: "Футболка Oversize + аксессуары"
                },
                { 
                    id: "#PF-4983", 
                    date: "2023-06-05", 
                    amount: 4500, 
                    status: "pending", 
                    items: 1,
                    title: "Джинсы Slim Fit"
                }
            ];
            
            renderOrders(mockOrders);
            ordersLoaded = true;
        }

        // Функция отображения заказов - ОБНОВИМ ДЛЯ ДЕМО-ДАННЫХ
        function renderOrders(orders) {
            ordersContainer.innerHTML = '';
            
            orders.forEach(order => {
                // ... (код из предыдущей версии с добавлением order.title) ...
                orderItem.innerHTML = `
                    <div class="order-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="order-details">
                        <div class="order-id">${order.id} • ${new Date(order.date).toLocaleDateString()}</div>
                        <div class="order-status">${order.title || `${order.items} товара`} • <span class="order-price">${order.amount.toLocaleString()} ₽</span></div>
                    </div>
                    <div class="status-badge ${statusClass}">${statusText}</div>
                `;
                // ... (остальное без изменений) ...
            });
        }

        // ... (остальные функции без изменений) ...

        // Если API недоступно, загружаем демо-данные сразу
        setTimeout(() => {
            if (!productsLoaded && !useDemoData) {
                showNotification('Используются демо-данные');
                loadMockData();
            }
        }, 3000);
    </script>
</body>
</html>
